<?php

/**
 * Implements hook_library_info_build().
 */
function kalastatic_library_info_build() {
  $build_file_path = \Drupal::config('kalastatic.settings')->get('kalastatic_build_path');
  $build_path = str_replace(DRUPAL_ROOT, '', $build_file_path);

  $libraries = [];
  $libraries['kalastatic'] = [
    'dependencies' => [
      'core/jquery',
    ],
    'license' => [
      'name' => 'MIT',
      'url' => 'https://opensource.org/licenses/MIT',
      'gpl-compatible' => TRUE,
    ],
    'css' => [
      'theme' => [
        $build_path . '/styles/main.css' => [],
      ],
    ],
  ];

  // Go through all the js files in the js folder and add them as part of the
  // library.
  $js_path = $build_path . '/js';
  foreach (scandir($js_path) as $key => $filename) {
    if (preg_match('/^.*\.(js)$/i', $filename)) {
      $libraries['kalastatic']['js'][$js_path . '/' . $filename] = [
        'type' => 'internal',
        'minified' => FALSE,
      ];
    }
  }

  return $libraries;
}

/**
 * Return the default path to Kalastatic
 *
 * The assumption is that it is inside a folder called 'kalastatic' in the
 * current default theme.
 */
function kalastatic_path_to_src_default() {
  $default_theme = \Drupal::config('system.theme')->get('default');
  return drupal_get_path('theme', $default_theme) . '/kalastatic';
}

/**
 * Return the path to the default build folder.
 *
 * Grep the kalastatic.yml file inside of the Kalastatic src folder and work out
 * where it's being built to.
 */
function kalastatic_path_to_build_default() {
  // TODO: Work some yaml magic.
  // FORNOW: hardcode because of our routing issues.
  return DRUPAL_ROOT . '/kalastatic';
}

/**
 * Implements hook_preprocess_html().
 *
 * Adds any KalaStatic-specific variables to Twig.
 */
function kalastatic_preprocess_html(&$variables) {
  // Add the build_path global variable so Twig can use it.
  if (!isset($variables['build_path'])) {
    // TODO Figure out the true destination path from kalastatic.yaml.
    $variables['build_path'] = base_path() . 'kalastatic/';
  }
}

/**
* Prepare the variables from a text_with_summary field.
 */
function kalastatic_prepare_field__text_with_summary($field, $node) {
  $output = [];
  foreach ($node->$field->getValue() as $i => $item) {
    $text = check_markup($item['value'], $item['format']); // TODO: langcode, cache??
    // TODO: We probably want to have an teaser option that returns the summary.
    $output[$i] = $text->__toString();
  }

  // If there's only a single image then don't return a nested array.
  return count($output) == 1 ? $output[0] : $output;
}

/**
 * Prepare the variables from an image field, ready for the image.html.twig
 */
function kalastatic_prepare_field__image($field, $node) {
  $imgs = [];
  foreach ($node->$field->getValue() as $i => $item) {
    $image_url = $node->get($field)->entity->uri->value;
    $imgs[$i] = [
      'url' => file_create_url($image_url),
      'title' => $item['title'],
      'alt' => $item['alt'],
      'width' => $item['width'],
      'height' => $item['height'],
    ];
  }

  // If there's only a single image then don't return a nested array.
  return count($imgs) == 1 ? $imgs[0] : $imgs;
}
